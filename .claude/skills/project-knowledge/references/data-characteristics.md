---
title: データ特性知識ベース
keywords:
  - データ特性
  - 外れ値
  - スパース
  - SKUマッチング
  - ロングテール
  - 品質チェック
  - クリーニング
  - 予測データ
  - 実績データ
  - 店舗
  - seller_id
  - sku_id
topics:
  - 予測データ特性
  - 実績データ特性
  - SKUマッチング問題
  - 外れ値パターン
  - データ品質チェック
  - 推奨対応策
updated: 2026-01-07
---

# データ特性知識ベース

実データの特徴、外れ値、制約を記録。

---

## 予測データ（ForecastWide）

### データ構造
- **パーティション**: base_date / seller_id
- **カラム形式**: base_date_later_day1〜365（累計予測）
- **1店舗あたりSKU数**: 数百〜数千

### 特徴
1. **スパースデータ**: 多くのSKUで予測値が0または小さい
2. **累計予測**: dayNは「base_date+1からbase_date+Nまでの累計」
3. **店舗ごとに異なるSKUセット**: 全店舗で同じSKUがあるわけではない

---

## 実績データ（SalesRecords）

### データ構造
- **パーティション**: seller_id
- **粒度**: SKU × 日付 × 店舗
- **カラム**: sku_id, date, quantity

### 特徴
1. **スパースデータ**: 販売がない日はレコードなし
2. **ロングテール分布**: 少数のSKUが売上の大部分を占める
3. **0以下の値**: クリーニング対象（返品等の可能性）

### 観測された制約
- `quantity`は正の値のみ有効
- NaN/Infは存在しうる（要クリーニング）

---

## SKUマッチング問題

### 問題
予測データと実績データでSKUが一致しないことが多い。

### 観測例（店舗: 71e10d67...）
| 項目 | 値 |
|------|-----|
| 予測SKU数 | 279 |
| day1実績SKU数 | 6 |
| 予測∩実績SKU数 | **2** |

### 原因
1. 新商品: 予測はあるが実績なし
2. 廃番商品: 実績はあるが予測なし
3. 販売なし: その日に売れなかっただけ

### 影響
- **bias_pct**: 実績が少ないと極端な値になる
- **WMAPE**: 同様に極端な値になる
- **median系指標**: 比較的ロバスト

---

## 外れ値パターン

### パターン1: 極端なbias_pct

**観測値**: bias_pct = 111.445

**原因分析**:
```
予測合計: 224.89
実績合計: 2.0（重複SKU2件のみ）
bias_pct = (224.89 - 2.0) / 2.0 = 111.445
```

**解釈**: 予測SKUと実績SKUがほぼ一致しない店舗

### パターン2: mean/medianの乖離

**観測値**:
- bias_pct_mean（全店舗）: 18.98%
- bias_pct_median_mean（全店舗）: 0.77%

**原因**: 少数の外れ値店舗が平均を大きく引き上げ

### パターン3: forecast_dayによる誤差増大

**観測値**:
| forecast_day | wmape_median |
|--------------|--------------|
| 1 | 0.3〜8 |
| 7 | 2〜10 |
| 14 | 4〜15 |

**原因**: 長期予測は不確実性が高い（期待される傾向）

---

## データ品質チェックポイント

### 前処理時
1. quantity > 0 のみ保持
2. NaN/Inf除去
3. 極端な外れ値（上位0.1%）の除去オプション

### 集計時
1. SKUマッチ率の確認
2. 実績0の割合確認
3. 分母が0になる場合の処理（clip to 1.0）

### 評価時
1. mean/medianの乖離確認
2. セグメント間の差異確認
3. forecast_dayによる傾向確認

---

## 推奨される対応

### 外れ値店舗の扱い
1. **除外しない**: ビジネス上の実態を反映
2. **median指標を重視**: 外れ値にロバスト
3. **店舗別レポート**: 問題店舗を特定

### SKUマッチ率低下への対応
1. **SKUマッピングの見直し**: マスタ不整合の可能性
2. **予測対象SKUの見直し**: 販売実績のないSKUを除外
3. **評価期間の見直し**: 短期（day1-7）に集中

### 精度指標の使い分け
| 目的 | 推奨指標 |
|------|----------|
| 全体傾向把握 | wmape, bias_pct |
| ロバストな評価 | mare_median, bias_pct_median |
| 重要SKU評価 | top_20pctセグメント |

# テストカテゴリ詳細ガイド

## 1. 正常系 (Happy Path)

### 基本動作

最も一般的なユースケースをカバーする。

**確認ポイント:**
- 典型的な入力で期待通りの出力が得られるか
- 主要なビジネスロジックが正しく実行されるか

**例（予測精度計算）:**
```gherkin
Scenario: 正常なデータで精度計算
  Given 予測値と実績値のデータがある
    | predicted | actual |
    | 100       | 90     |
    | 200       | 180    |
  When 精度計算を実行する
  Then WMAPEが計算される
```

### 複数データ

リスト・バッチ処理の正確性を確認。

**確認ポイント:**
- 複数レコードの集計が正しいか
- 順序依存の処理が正しいか

### オプショナルフィールド

省略可能なパラメータの扱いを確認。

**確認ポイント:**
- デフォルト値が適用されるか
- 明示的に渡した場合に上書きされるか

---

## 2. 境界値・エッジケース

### 空データ (n=0)

**最重要**: 多くのバグはここで発生する。

**確認ポイント:**
- 空リスト/空DataFrameで例外が発生しないか
- 適切なデフォルト値（0, NaN, 空リスト等）が返されるか

**パターン:**
```python
# 入力
[]
pl.DataFrame({})
SkuErrors(data=pl.DataFrame({}).lazy())

# 期待される出力の例
- 0 を返す
- math.nan を返す
- 空のDTOを返す
- 適切な例外を投げる
```

### 単一データ (n=1)

集計処理で特に重要。

**確認ポイント:**
- 平均/中央値が正しく計算されるか
- 標準偏差がNaNまたは0になるか（実装依存）

### 数値境界

| 値 | 確認内容 |
|-----|----------|
| 0 | ゼロ除算、ゼロ乗算の扱い |
| 1 | 最小の正値での挙動 |
| -1 | 最小の負値での挙動 |
| 1e10 | 大きな値でのオーバーフロー |
| 1e-10 | 小さな値での精度損失 |
| inf | 無限大の伝播 |
| -inf | 負の無限大の伝播 |
| nan | NaNの伝播・除外 |

### null/None

**確認ポイント:**
- null値を含むデータでクラッシュしないか
- null値の扱いが仕様通りか（除外/置換/エラー）

**パターン:**
```python
# Polarsでのnullチェック
df = pl.DataFrame({"quantity": [10, None, 20]})

# 期待される挙動の例
- null行を除外する
- null値を0で置換する
- TypeErrorを投げる
```

---

## 3. 異常系

### 型エラー

**確認ポイント:**
- 不正な型が渡された場合の挙動
- エラーメッセージが分かりやすいか

**パターン:**
```python
# 期待: Float64カラム
# 実際: Stringカラム
df = pl.DataFrame({"quantity": ["a", "b", "c"]})
```

### 範囲外

**確認ポイント:**
- 許容範囲外の値に対する挙動
- バリデーションメッセージが適切か

**パターン:**
```python
# 負の数量
quantity = -10

# 未来の日付
date = datetime.now() + timedelta(days=365)

# 100%を超える割合
percentage = 1.5
```

### 不整合

**確認ポイント:**
- 参照整合性エラーの扱い
- 矛盾するデータの検出

**パターン:**
```python
# JOINで片方にしかないデータ
forecast_skus = ["sku1", "sku2", "sku3"]
sales_skus = ["sku1", "sku2"]  # sku3がない

# 矛盾する値
start_date > end_date
```

---

## 4. ビジネスロジック固有

### ドメインルール

プロジェクト固有のビジネスルールをテスト。

**例（予測精度評価）:**
- 上位20%のSKUが正しく識別されるか
- +1スムージングが適用されているか
- セグメント別集計が正しいか

### 計算精度

数値計算の正確性を確認。

**確認ポイント:**
- 浮動小数点誤差が許容範囲内か
- 丸め処理が仕様通りか

**パターン:**
```python
# pytest.approxを使用
assert result == pytest.approx(expected, rel=0.01)
```

### 状態遷移

Stateful処理（Transformer等）の状態変化を確認。

**確認ポイント:**
- fit前のtransformでエラーになるか
- fitした状態が正しく保持されるか

---

## 5. データフロー

### 入出力整合性

パイプラインの入出力DTOが正しく変換されるか。

**確認ポイント:**
- 入力DTOの全フィールドが適切に処理されるか
- 出力DTOに必要なフィールドが全て含まれるか

### カラム保持

処理中にカラムが失われないか。

**確認ポイント:**
- 必須カラムが出力に存在するか
- 不要なカラムが適切に除外されるか

### 型維持

データ型が意図通りに変換されるか。

**確認ポイント:**
- スキーマで定義した型になっているか
- 暗黙の型変換が発生していないか

---

## コンポーネント別重点テスト

| コンポーネント | 重点カテゴリ |
|---------------|-------------|
| DTO (schemas/) | 型検証、バリデーション、空データ |
| Processor | 入出力整合性、境界値、ビジネスロジック |
| Transformer | 状態遷移、fit/transform整合性 |
| Pipeline | データフロー、E2E、エラー伝播 |
| Calculator | 計算精度、境界値、数値例外 |

---

## テスト優先度マトリクス

| 優先度 | カテゴリ | 理由 |
|--------|---------|------|
| **Critical** | 空データ | バグの温床、本番で頻発 |
| **Critical** | null/None | 実データに必ず含まれる |
| **High** | 基本動作 | 主要機能の確認 |
| **High** | ビジネスロジック | ドメイン要件の確認 |
| **Medium** | 境界値 | エッジケースの防御 |
| **Medium** | データフロー | 統合時の問題検出 |
| **Low** | 大量データ | パフォーマンス問題 |

# 検証チェックリスト

AI生成コードの正しさを人間が確認するためのチェックリスト。

## 1. データ品質検証

### 入力データ

```markdown
| チェック項目 | 基準 | 確認方法 | 結果 |
|-------------|------|---------|------|
| スキーマ一致 | 100% | Pydantic検証 | |
| 欠損率 | < 5% | `df.isnull().mean()` | |
| 重複行 | 0件 | `df.duplicated().sum()` | |
| 外れ値 | IQR×3以内 | 四分位分析 | |
| 型一致 | 全列 | `df.dtypes` | |
```

### 時系列データ特有

```markdown
| チェック項目 | 基準 | 確認方法 |
|-------------|------|---------|
| 時間順序 | 昇順 | `df['date'].is_monotonic` |
| 欠落日付 | なし | date_range比較 |
| 未来日付混入 | なし | `df['date'] <= today` |
| 季節性確認 | パターン検出 | ACF/PACF分析 |
```

## 2. 特徴量検証

### リーク検出

```markdown
□ 時間的リーク
  - shift(-n) がないか（未来参照）
  - rolling(closed='left') を使用しているか
  - 集計が未来データを含まないか

□ ターゲットリーク
  - 目的変数から派生した特徴量がないか
  - 予測時点で利用不可能な情報がないか

□ 確認コード:
  ```python
  # 特徴量とターゲットの相関
  corr = df[features].corrwith(df[target])
  suspicious = corr[corr.abs() > 0.95]  # 要調査
  ```
```

### 多重共線性

```markdown
| 特徴量ペア | VIF | 判定 |
|-----------|-----|------|
| lag7 | 2.3 | OK |
| rolling30 | 3.1 | OK |
| lag1 | 8.7 | NG（除外） |

基準: VIF < 5
```

### 分布確認

```markdown
| 特徴量 | 分布 | 変換 |
|--------|------|------|
| sales | 右裾長 | log変換 |
| quantity | ゼロ過多 | そのまま |
| price | 正規 | なし |
```

## 3. モデル検証

### 学習・評価分割

```markdown
□ 時系列の場合
  - TimeSeriesSplit使用
  - 未来→過去の漏洩なし
  - ギャップ（gap）設定の妥当性

□ 一般データの場合
  - ランダム分割のシード固定
  - 層化抽出（Stratified）の使用
  - グループ依存性の考慮

□ 確認事項:
  | 項目 | 設定 |
  |------|------|
  | CV手法 | TimeSeriesSplit |
  | fold数 | 5 |
  | gap | 7日 |
  | random_state | 42 |
```

### 性能評価

```markdown
| 指標 | 値 | ベースライン | 改善率 |
|------|-----|-------------|--------|
| RMSE | 0.23 | 0.31 | 26% |
| MAE | 0.18 | 0.25 | 28% |
| R² | 0.72 | 0.58 | +14pt |

□ 過学習チェック:
  | データ | RMSE |
  |--------|------|
  | Train | 0.21 |
  | Valid | 0.23 |
  | Gap | 9.5% (<10% OK) |
```

### 統計的有意性

```markdown
□ モデル比較検定
  - Wilcoxon符号順位検定: p < 0.05
  - 効果量 (Cohen's d): > 0.5

□ 係数の有意性
  | 特徴量 | 係数 | p値 | 判定 |
  |--------|------|-----|------|
  | lag7 | 0.32 | 0.001 | *** |
  | rolling30 | 0.18 | 0.023 | * |
  | intercept | 1.24 | 0.000 | *** |
```

## 4. 理論的妥当性

### モデル前提条件

```markdown
□ GLM前提
  - リンク関数の適切性
  - 分布族の適合性
  - 独立性の仮定

□ 検定結果
  | 検定 | 統計量 | p値 | 判定 |
  |------|--------|-----|------|
  | 残差正規性 (Shapiro-Wilk) | 0.98 | 0.12 | OK |
  | 等分散性 (Levene) | 1.24 | 0.34 | OK |
  | 自己相関 (Durbin-Watson) | 2.01 | - | OK |
```

### 係数解釈

```markdown
| 特徴量 | 係数 | 解釈 | ドメイン整合性 |
|--------|------|------|--------------|
| price | -0.15 | 価格1%↑で売上0.15%↓ | ✓ 妥当 |
| promo | +0.42 | プロモで42%増 | ✓ 妥当 |
| competitor | -0.08 | 競合影響 | ✓ 妥当 |

□ 符号の確認:
  - 全係数がドメイン知識と一致: ✓
  - 不自然な符号: なし
```

## 5. 再現性検証

### 環境固定

```markdown
| 項目 | 設定 |
|------|------|
| Python | 3.11.5 |
| numpy | 1.26.0 |
| scikit-learn | 1.4.0 |
| random_state | 42 |
| PYTHONHASHSEED | 42 |
```

### シード設定

```python
# 再現性確保コード
import numpy as np
import random

SEED = 42
np.random.seed(SEED)
random.seed(SEED)

# PyTorch使用時
# torch.manual_seed(SEED)
# torch.cuda.manual_seed_all(SEED)
# torch.backends.cudnn.deterministic = True
```

### 再現確認

```markdown
□ 同一環境で2回実行
  - 結果が一致: ✓
  - 差異がある場合の許容範囲: ±1e-6

□ 別環境で実行
  - Docker/CI環境で再現: ✓
  - 結果の差異: なし
```

## 6. 運用検証

### 推論時間

```markdown
| 処理 | 時間 | 基準 | 判定 |
|------|------|------|------|
| 1件予測 | 5ms | < 100ms | OK |
| バッチ1000件 | 120ms | < 1s | OK |
| 日次全件 | 3.2s | < 60s | OK |
```

### メモリ使用量

```markdown
| 処理 | メモリ | 基準 | 判定 |
|------|--------|------|------|
| モデルロード | 50MB | < 1GB | OK |
| 推論時ピーク | 200MB | < 4GB | OK |
```

### エッジケース

```markdown
| ケース | 期待動作 | 実際 | 判定 |
|--------|---------|------|------|
| 空入力 | 空結果 | 空結果 | OK |
| 欠損値 | エラー | ValidationError | OK |
| 極端値 | 警告+処理 | Warning出力 | OK |
| 新カテゴリ | Unknown処理 | fallback適用 | OK |
```

## 検証結果サマリー

```markdown
## 検証サマリー

**実施日**: 2024-XX-XX
**実施者**: {名前}

### 結果

| カテゴリ | 項目数 | OK | NG | 備考 |
|---------|--------|----|----|------|
| データ品質 | 5 | 5 | 0 | |
| 特徴量 | 8 | 7 | 1 | VIF警告1件 |
| モデル | 6 | 6 | 0 | |
| 理論的妥当性 | 4 | 4 | 0 | |
| 再現性 | 3 | 3 | 0 | |
| 運用 | 4 | 4 | 0 | |

### 未解決事項

- [ ] VIF > 5の特徴量（lag1）を除外検討

### 承認

- [ ] データサイエンティスト確認
- [ ] コードレビュー完了
- [ ] 本番デプロイ承認
```
